Data Manipulation with dplyr
============================

# 1. Transforming Data with dplyr

## 1.1 The counties dataset

* Chapter 1 verbs

  * `select()`
  * `filter()`
  * `arrange()`
  * `mutate()`

```R
# take a look at the dataset
glimpse(counties)

# select()
counties %>%
  select(state, county, population, unemployment)
  
# creating a new table
counties_selected <- counties %>%
  select(state, county, population, unemployment)
```

## 1.2 The filter and arragne verbs

* Arrange

```
counties_selected %>%
  arrange(population)
```

* Arrange: descending

```
counties_selected %>%
  arrange(desc(population))
```

* Filter

```
counties_selected %>%
  arrange(desc(population)) %>%
  filter(state == "New York")
  
counties_selected %>%
  arrange(desc(population)) %>%
  filter(unemployment < 6)
```

* Combining conditions

```
counties_selected %>%
	arrange(desc(population)) %>%
	filter(state == "New York", unemployment < 6)
```

## 1.3 Mutate

* Mutate

```
counties_selected %>%
	mutate(unemployed_population = population * unemployment / 100) %>%
	arrange(desc(unemployed_population))
```

# 2. Aggregating Data

## 2.1 The count verb

```
counties %>%
	count()
```

* Count variable

```
counties %>%
	count(state)
```

* Count and sort

```
counties %>%
	count(state, sort= TRUE)
```

* Add weight

```
counties %>%
	count(state, wt = population, sort = TRUE)
```

## 2.2 The group by, summarize and ungroup verbs

* Summarize

```
counties %>%
	summarize(total_population = sum(population))
```

* Aggregate and summarize

```
counties %>%
	summarize(total_population = sum(population),
		average_unemployment = mean(unemployment))
```

* Summary functions

		* `sum()`
		* `mean()`
		* `median()`
		* `min()` : maximum
		* `max()` : minimum
		* `n()` : size of the group

* Aggregate within groups

```
counties %>%
	group_by(state) %>%
	summarize(total_pop = sum(population),
		averge_unemployment = mean(unemployment))
```

* Arrange

```
counties %>%
	group_by(state) %>%
	summarize(total_pop = sum(population),
		average_unemployment = mean(unemployment)) %>%
	arrange(desc(average_unemployment))
```

* Metro column

```
counties %>%
	select(state, metro, county, population)
```

* Group by

```
counties %>%
	group_by(state, metro) %>%
	summarize(total_pop = sum(population))
```

* Ungroup

```
counties %>%
	group_by(state, metro) %>%
	summarize(total_pop = sum(population))
	ungroup()
```

## 2.3 The top_n verb

* `top_n`

```
counties_selected <- counties %>%
	select(state, county, population, unemployment, income)
	
# get the county with the highest population from each state
counties_selected %>%
	group_by(state) %>%
	top_n(1, population)
	
# get the top three counties with the highest population from each state
counties_selected %>%
	group_by(state) %>%
	top_n(3, population)
```

# 3. Selecting and Transforming Data

## 3.1 Selecting

* Select a range with `:`

```
counties %>%
	select(state, county, drive:work_at_home) %>%
	arrange(drive)
```

* `contains()`

```
counties %>%
	select(state, county, contains("work"))
```

* `starts_with()`

```
counties %>%
	select(state, county, starts_with("income))
```

* `ends_with()`

* `last_col()`

* For more: `?select_helpers`

* Removing a variable with minus `-`

```
counties %>%
	select(-census_id)
```

## 3.2 The rename verb

* Rename a column

```
counties_selected %>%
	rename(unemployment_rate = unemployment)
```

* Combine verbs

```
counties_selected %>%
	select(state, county, population, unemployment_rate = unemployment)
```

* Compare verbs

```
# select
counties %>%
	select(state, county, population, unemployment_rate = unemployment)
	
# rename
counties %>%
	select(state, county, population, unemployment) %>%
	rename(unemployment_rate = unemployment)
```

## 3.3 The transmute verb

* Transmute

		* Combination: select & mutate
		* Returns a subset of columns that are transformed and changed

* Select and calculate

```
counties %>%
	transmute(state, county, fraction_men = men / population)
```

* Summary

|                   | Keeps only specified variables | Keeps other variables|
|:-----------------:|:------------------------------:|:--------------------:|
|Can't change values| select()                       | rename()             |
|Can change values  | transmute()                    | mutate()             |


# 4. Case Study: The babynames Dataset

## 4.1 The babynames data

```R
# import babynames data
> install.packages("readr")
> library(readr)
> babynames <- read_csv("NationalNames.csv")
> head(babynames)
# A tibble: 6 × 5
     Id Name       Year Gender Count
  <dbl> <chr>     <dbl> <chr>  <dbl>
1     1 Mary       1880 F       7065
2     2 Anna       1880 F       2604
3     3 Emma       1880 F       2003
4     4 Elizabeth  1880 F       1939
5     5 Minnie     1880 F       1746
6     6 Margaret   1880 F       1578

# select data and rename the col_name
> install.packages("dplyr")
> library(dplyr)
> babynames <- babynames %>%
+     select(year = Year, name = Name, number = Count)
> babynames
# A tibble: 1,825,433 × 3
    year name      number
   <dbl> <chr>      <dbl>
 1  1880 Mary        7065
 2  1880 Anna        2604
 3  1880 Emma        2003
 4  1880 Elizabeth   1939
 5  1880 Minnie      1746
 6  1880 Margaret    1578
 7  1880 Ida         1472
 8  1880 Alice       1414
 9  1880 Bertha      1320
10  1880 Sarah       1288
# … with 1,825,423 more rows

# select the name "Amy"
> babynames_selected <- babynames %>%
+     filter(name == "Amy")
> babynames_selected
# A tibble: 196 × 3
    year name  number
   <dbl> <chr>  <dbl>
 1  1880 Amy      167
 2  1881 Amy      145
 3  1882 Amy      196
 4  1883 Amy      209
 5  1884 Amy      205
 6  1885 Amy      240
 7  1886 Amy      226
 8  1887 Amy      251
 9  1888 Amy      236
10  1889 Amy      252
# … with 186 more rows

# plot
> library(ggplot2)
> ggplot(babynames_selected, aes(x = year, y = number)) +
+     geom_line()

# filter for multiple names
> babynames_multiple <- babynames %>%
+     filter(name %in% c("Amy", "Christopher"))

# When was each name most common?
> babynames %>%
+     group_by(name) %>%
+     top_n(1, number)
# A tibble: 115,640 × 3
# Groups:   name [93,889]
    year name     number
   <dbl> <chr>     <dbl>
 1  1880 Manerva      10
 2  1880 Neppie        7
 3  1880 Arch         61
 4  1880 Redden        6
 5  1881 Zilpah        9
 6  1881 Garfield    147
 7  1881 Ole          42
 8  1881 Chin         11
 9  1881 Roll          5
10  1882 Crete         8
# … with 115,630 more rows
```




## 4.2 Grouped mutates




## 4.3 Window functions



	











